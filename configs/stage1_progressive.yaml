# configs/stage1_progressive.yaml

# ============================================================================
# MODEL CONFIGURATION
# ============================================================================
# Change this to switch between model sizes: 'n', 's', 'm', 'l', 'x'
model_size: 'x'  # YOLO11 size (nano, small, medium, large, xlarge)

# Base paths (automatically includes model size)
base:
  checkpoint_dir: 'ttq_checkpoints'  # Base directory for all checkpoints
  wandb_project: 'ttq-yolo'          # Wandb project name
  wandb_entity:  # Your wandb username/team and put use_wandb to true

# ============================================================================
# STAGE DEFINITIONS
# ============================================================================
stages:
  stage1:
    name: 'stage1_progressive_shallow'
    description: 'Progressive quantization - Stage 1: Shallow layers only'
    
    model:
      weights: 'yolo11${model_size}.pt'  # Will be interpolated: yolo11n.pt, yolo11s.pt, etc.
    
    quantization:
      threshold: 0.715
      quantize_first_layer: false
      quantize_1x1_conv: true
      target_layers: [17, 19, 20, 22]
    
    train:
      epochs: 100
      batch: 8
      imgsz: 640
      lr0: 0.0001
      weight_decay: 0.0005
      optimizer: 'Adam'
      workers: 8
      device: 0
      patience: 4
    
    val:
      batch: 16
      imgsz: 640
    
    logging:
      name: 'stage1_progressive_shallow'
      save_dir: '${base.checkpoint_dir}/yolo11${model_size}/stage1_progressive'  # yolo11n/stage1_progressive
      use_wandb: false
      wandb_project: '${base.wandb_project}'
      wandb_entity: '${base.wandb_entity}'
      wandb_run_name: 'yolo11${model_size}_stage1'  # Unique wandb run name


  stage2:
    name: 'stage2_progressive_middle'
    description: 'Progressive quantization - Stage 2: Middle layers'
    
    model:
      # Automatically loads from stage1 output of same model size
      weights: '${base.checkpoint_dir}/yolo11${model_size}/stage1_progressive/best.pt'
    
    quantization:
      threshold: 0.715
      quantize_first_layer: false
      quantize_1x1_conv: false
      target_layers: [7, 8, 9, 13, 16]
    
    train:
      epochs: 200
      batch: 8
      imgsz: 640
      lr0: 0.0001
      weight_decay: 0.0005
      optimizer: 'Adam'
      workers: 8
      device: 0
      patience: 4
    
    val:
      batch: 16
      imgsz: 640
    
    logging:
      name: 'stage1_progressive_middle'
      save_dir: '${base.checkpoint_dir}/yolo11${model_size}/stage1_progressive_middle'  # yolo11n/stage2_progressive
      use_wandb: false
      wandb_project: '${base.wandb_project}'
      wandb_entity: '${base.wandb_entity}'
      wandb_run_name: 'yolo11${model_size}_stage2'


  stage3:
    name: 'stage3_progressive_deep'
    description: 'Progressive quantization - Stage 3: Deep layers'
    
    model:
      # Automatically loads from stage2 output of same model size
      weights: '${base.checkpoint_dir}/yolo11${model_size}/stage1_progressive_middle/best.pt'
    
    quantization:
      threshold: 0.7
      quantize_first_layer: false
      quantize_1x1_conv: false  # Enable 1x1 quantization in final stage
      target_layers: [2, 3, 4, 5, 6]
    
    train:
      epochs: 300
      batch: 8
      imgsz: 640
      lr0: 0.0001
      weight_decay: 0.0005
      optimizer: 'Adam'
      workers: 8
      device: 0
      patience: 4
    
    val:
      batch: 16
      imgsz: 640
    
    logging:
      name: 'stage3_progressive_deep'
      save_dir: '${base.checkpoint_dir}/yolo11${model_size}/stage1_progressive_final'  
      use_wandb: false
      wandb_project: '${base.wandb_project}'
      wandb_entity: '${base.wandb_entity}'
      wandb_run_name: 'yolo11${model_size}_stage3'


# ============================================================================
# DATA SETTINGS (shared across all stages)
# ============================================================================
data:
  train: 'coco.yaml'
  val: 'coco.yaml'


# ============================================================================
# FOLDER STRUCTURE EXAMPLE
# ============================================================================
# ttq_checkpoints/
# ├── yolo11n/
# │   ├── stage1_progressive/
# │   │   ├── best.pt
# │   │   ├── epoch_1.pt
# │   │   ├── epoch_2.pt
# │   │   └── ...
# │   ├── stage2_progressive/
# │   │   └── ...
# │   └── stage3_progressive/
# │       └── ...
# ├── yolo11s/
# │   ├── stage1_progressive/
# │   ├── stage2_progressive/
# │   └── stage3_progressive/
# └── yolo11m/
#     └── ...
# ============================================================================
